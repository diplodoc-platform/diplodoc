name: Update AGENTS.md

on:
  schedule:
    # Run weekly on Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  update-agents:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for AGENTS.md updates
        id: check-updates
        run: |
          echo "Checking for AGENTS.md files that need updates..."
          
          # Find all AGENTS.md files
          AGENTS_FILES=$(find . -name "AGENTS.md" -type f | grep -v node_modules | grep -v ".git")
          
          UPDATES_NEEDED=false
          
          for file in $AGENTS_FILES; do
            echo "Checking $file..."
            
            # Check if file mentions outdated patterns
            # Example: check for references to deprecated packages
            if grep -q "@diplodoc/eslint-config\|@diplodoc/prettier-config" "$file" 2>/dev/null; then
              echo "Found outdated package references in $file"
              UPDATES_NEEDED=true
            fi
            
            # Check for outdated version references
            # Example: check for specific old versions
            if grep -q "vitest@\^1\." "$file" 2>/dev/null; then
              echo "Found outdated version reference in $file"
              UPDATES_NEEDED=true
            fi
          done
          
          if [ "$UPDATES_NEEDED" = true ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Create update branch
        if: steps.check-updates.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b update-agents-md-$(date +%Y%m%d)

      - name: Update AGENTS.md files
        if: steps.check-updates.outputs.needs_update == 'true'
        run: |
          echo "Updating AGENTS.md files..."
          
          # Find all AGENTS.md files
          find . -name "AGENTS.md" -type f | grep -v node_modules | grep -v ".git" | while read file; do
            echo "Processing $file..."
            
            # Replace deprecated package references
            sed -i 's/@diplodoc\/eslint-config/@diplodoc\/lint/g' "$file" || true
            sed -i 's/@diplodoc\/prettier-config/@diplodoc\/lint/g' "$file" || true
            
            # Update outdated version references
            sed -i 's/vitest@\^1\./vitest@^2./g' "$file" || true
            
            # Update outdated procedure references
            # Example: if we change a procedure, update references
          done
          
          echo "✅ AGENTS.md files updated"

      - name: Commit changes
        if: steps.check-updates.outputs.needs_update == 'true'
        run: |
          git add -A
          git diff --staged --quiet || git commit -m "chore: update AGENTS.md files

          - Update outdated package references
          - Update version numbers
          - Auto-generated by update-agents workflow"

      - name: Create Pull Request
        if: steps.check-updates.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore: Update AGENTS.md files"
          body: |
            This PR automatically updates AGENTS.md files across the repository.
            
            **Changes:**
            - Updated outdated package references
            - Updated version numbers
            - Ensured consistency across all AGENTS.md files
            
            **Generated by:** update-agents workflow
          branch: update-agents-md-$(date +%Y%m%d)
          delete-branch: true

      - name: Summary
        if: steps.check-updates.outputs.needs_update == 'false'
        run: |
          echo "✅ All AGENTS.md files are up to date. No updates needed."

